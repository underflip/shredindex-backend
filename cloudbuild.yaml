steps:
    # Print directory contents for debugging
    - name: 'ubuntu'
      entrypoint: 'bash'
      args:
          - '-c'
          - |
              echo "Current directory:"
              pwd
              echo "Contents of current directory:"
              ls -la
              echo "Searching for Dockerfile:"
              find . -name Dockerfile

    # Build the application
    - name: 'gcr.io/cloud-builders/docker'
      args: [
          'build',
          '-t', 'us-central1-docker.pkg.dev/shred-index-social-login/shredindex-repo/backend:$BUILD_ID',
          '.'
      ]

    # Push the container image to Container Registry
    - name: 'gcr.io/cloud-builders/docker'
      args: ['push', 'us-central1-docker.pkg.dev/shred-index-social-login/shredindex-repo/backend:$BUILD_ID']

    # Deploy container image to Cloud Run
    - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
      entrypoint: gcloud
      args:
          - 'run'
          - 'deploy'
          - 'backend'
          - '--image'
          - 'us-central1-docker.pkg.dev/shred-index-social-login/shredindex-repo/backend:$BUILD_ID'
          - '--region'
          - 'us-central1'
          - '--platform'
          - 'managed'
          - '--allow-unauthenticated'
          - '--set-env-vars'
          - 'DATABASE_URL=${_DATABASE_URL}'

images:
    - 'us-central1-docker.pkg.dev/shred-index-social-login/shredindex-repo/backend:$BUILD_ID'

substitutions:
    _DATABASE_URL: 'mysql://user:pass@shredindex-backend-mysql:3306/shredindex'
